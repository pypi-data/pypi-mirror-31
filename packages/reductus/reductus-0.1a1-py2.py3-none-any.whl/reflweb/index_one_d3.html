<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>Reflectometry reduction</title>
        <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.11.1.custom/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/jquery.jsonrpc.js"></script>
        <script type="text/javascript" src="js/jstree/dist/jstree.min.js"></script>
        <script type="text/javascript" src="js/jquery.layout-latest.js"></script>

        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="js/plot_d3_rz.js"></script>
        
        <link rel="stylesheet" href="css/layout-default-latest.css" />
        <link rel="stylesheet" href="js/jstree/docs/assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="js/jstree/dist/themes/default/style.min.css"/>
        <link rel="stylesheet" href="js/jquery-ui-1.11.1.custom/jquery-ui.min.css" />
        <link rel="stylesheet" href="js/jquery-ui-1.11.1.custom/jquery-ui.theme.min.css" />
        <link rel="stylesheet" href="js/jquery-ui-1.11.1.custom/jquery-ui.structure.min.css" />
        <script type="text/javascript">
            SORT_KEYS = true;
            ERRORBARS = false;
            plots = {};
            colorbars = {};
            data = null;
            
            function qs() {
                var qsParm = {};
                var query = window.location.search.substring(1);
                var parms = query.split('&');
                for (var i=0; i<parms.length; i++) {
                    var pos = parms[i].indexOf('=');
                    if (pos > 0) {
                        var key = parms[i].substring(0,pos);
                        var val = parms[i].substring(pos+1);
                        qsParm[key] = val;
                    }
                }
                return qsParm;
            }
            
            function type (object) {
                if (object === null) {
                    return 'null';
                }
                if (object === undefined) {
                    return 'undefined';
                }
                if ((object instanceof Number) || (typeof object === 'number')) {
                    return 'number';
                }
                if ((object instanceof String) || (typeof object === 'string')) {
                    return 'string';
                }
                if ((object instanceof Boolean) || (typeof object === 'boolean')) {
                    return 'boolean';
                }
                if ((object instanceof RegExp) || (typeof object === 'regexp')) {
                    return 'regexp';
                }
                if (Array.isArray(object)) {
                    return 'array';
                }

                return 'object';
            };
            
            function json_to_jstree(obj, root) {
                var simplenodes = {'string': true, 'boolean': true, 'number': true, 'null': true}
                if (root == true) {
                    return {'core': {'data': json_to_jstree(obj, false)}}
                }
                
                var out;
                if (type(obj) === 'object') {
                    var keys = Object.keys(obj);
                    var val, text;
                    if (SORT_KEYS) { keys.sort(function(a, b){return parseFloat(a)-parseFloat(b)}) }
                    out = [];
                    for (var i=0; i<keys.length; i++) {
                        val = obj[keys[i]];
                        if (type(val) in simplenodes) {
                            out.push({'text': '<b>'+ keys[i] + ':</b> ' + String(val), 'icon': "glyphicon glyphicon-chevron-right"});
                        } else {
                            out.push({'text': keys[i], 'children': json_to_jstree(obj[keys[i]]) });
                        }
                    }        
                }
                else if( type(obj) === 'array' ) {
                    out = [];
                    for (var i=0; i<obj.length; i++) {
                        out.push(json_to_jstree(obj[i]));
                    }
                }
                else if( type(obj) === 'string') {
                    out = {'text': obj, 'icon': "glyphicon glyphicon-chevron-right"};
                }
                else if( type(obj) === 'number') {
                    out = {'text': obj.toString(), 'icon': "glyphicon glyphicon-chevron-right" };
                }
                else { 
                    out = {'text': 'unknown'};
                    //alert( 'not a known type: ', String(obj) );
                }
                return out;
            }
            
            
            scan_directory = function(event, path) {
                var path = path || $('#data_path').val();
                //$.jsonRPC.request('categorize_files', { 
                //$.jsonRPC.request('get_jstree', {
                $.jsonRPC.request('get_file_metadata', {
                    params: [path], 
                    success: function(result) {
                        //file_list = result.result;
                        //tree_version = json_to_jstree(file_list, true);
                        metadata = result.result;
                        var categorized_files = categorize_files(metadata);
                        var tree_version = make_jstree(categorized_files, true);
                        $('#file_tree').jstree(tree_version);
                    }, 
                    error: function(result) {console.log('error: ', result)}
                });
            }
            
            categorize_files = function(metadata) {
                // metadata is list of file information, 
                // [{'filename': ...}, {'filename': ...} ...]
                
                var output = {}, item, name, num, scanType, entry, newid, d;
                for (var i=0; i<metadata.length; i++) {
                    item = metadata[i];
                    d = {};
                    if (!(item.sample_name in output)) {
                        output[item.sample_name] = {};
                    }
                    if (!(item.scanType in output[item.sample_name])) {
                        output[item.sample_name][item.scanType] = {};
                    }
                    if (!(item.fileNum in output[item.sample_name][item.scanType])) {
                        output[item.sample_name][item.scanType][item.fileNum] = {};
                    }
                    //newid = item.fileNum + ":" + item.entry
                    
                    output[item.sample_name][item.scanType][item.fileNum][item.entry] = {path: item.path, filename: item.filename, entry: item.entry};
                }
                return output
            }
            
            make_jstree = function(categorized, sort_keys) {
                // categorized is a JS object with structure sample name -> scanType -> [filenum + entryname]  
                // [{'filename': ...}, {'filename': ...} ...]
                var output = {
                    "core": {"data": []},
                    "checkbox": {"keep_selected_style": true},
                    "plugins": ["checkbox"]
                };
                var names = Object.keys(categorized);
                if (sort_keys) { names.sort(); }
                var ndata, name;
                var scanTypes, scanType, sdata;
                var nums, num, numdata;
                var entries, entry, edata;
                for (var i=0; i<names.length; i++) {
                    name = names[i];
                    namedata = categorized[name];
                    var n_out = {"text": name, "children": []};
                    scanTypes = Object.keys(namedata);
                    if (sort_keys) { scanTypes.sort(); }
                    for (var j=0; j<scanTypes.length; j++) {
                        scanType = scanTypes[j];
                        sdata = namedata[scanType];
                        var s_out = {"text": scanType, "children": []};
                        nums = Object.keys(sdata);                        
                        for (var k=0; k<nums.length; k++) {                           
                            num = nums[k];
                            numdata = sdata[num];
                            var num_out = {"text": num }; //"children": []}
                            entries = Object.keys(numdata);
                            if (entries.length > 1) {
                                num_out.children = [];
                                for (var l=0; l<entries.length; l++) {                            
                                    entry = entries[l];
                                    edata = numdata[entry];
                                    var e_out = {
                                        "text": entry, 
                                        //"icon": "glyphicon glyphicon-chevron-right", 
                                        "icon": "none",
                                        "a_attr": {
                                            "filename": edata.filename,
                                            "path": edata.path,
                                            "entry": edata.entry
                                        }        
                                    }
                                    num_out.children.push(e_out);
                                }
                            } else {
                                edata = numdata[entries[0]];
                                num_out.text += ": " + edata.entry;
                                num_out.a_attr = {
                                    "filename": edata.filename,
                                    "path": edata.path,
                                    "entry": edata.entry
                                }
                            }
                            s_out.children.push(num_out);
                        }
                        n_out.children.push(s_out);
                    }
                    output.core.data.push(n_out);
                }
                return output;
            }
            
            dirHelper = "http://ncnr.nist.gov/instruments/magik/listftpfiles.php";
            
            getftp = function(path) {
                $.post(dirHelper, {'pathlist': path}, function(r) { ftplist = r; console.log(r); });
            }
            
            //$.post(dirHelper, {'pathlist': data_path}, updateFileBrowserPane("navigation", data_path));
            
            function createTable(target, cols, numCells) {
                // create a table with numCells in the target
                var table = $('<table />', {'id': 'plot_table'});
                $('#'+target).append(table);
                var cells = 0;
                for (var r=0; cells < numCells; r++) {
                    var row = $('<tr />');
                    table.append(row);
                    for (var c=0; c<cols && cells < numCells; c++) {
                        var cell = $('<td />', {'class': 'plotcell', 'id': 'cell' + (cells+1).toFixed()});
                        cell.append($('<div />', {'id': 'plot'+(cells+1).toFixed(), 'class': 'plotdiv', 'plotnum': (cells+1).toFixed()}));
                        var xtransform = $('<label />', {'class': 'transform', 'axis': 'xaxis'}).text('logX').append($('<input />', {'type': 'checkbox'}));
                        cell.append(xtransform);
                        var ytransform = $('<label />', {'class': 'transform', 'axis': 'yaxis'}).text('logY').append($('<input />', {'type': 'checkbox'}));
                        cell.append(ytransform);
                        var ztransform = $('<label />', {'class': 'transform', 'axis': 'zaxis'}).text('logZ').append($('<input />', {'type': 'checkbox'}));
                        cell.append(ztransform);
                        var showline = $('<label />',  {'class': 'showline'}).text('show line').append($('<input />', {'type': 'checkbox'}));
                        cell.append(showline);
                        var showmarker = $('<label />', {'class': 'showmarker'}).text('show points').append($('<input />', {'type': 'checkbox'}));
                        cell.append(showmarker);
                        row.append(cell);
                        cells++;
                    }
                }
            }
            
            function updatePlotOptions(ev) {
                var logx = $('.transform[axis=xaxis] input').prop('checked');
                var logy = $('.transform[axis=yaxis] input').prop('checked');
                var showline = $('.showline input').prop('checked');
                var showmarker = $('.showmarker input').prop('checked');

                $("#plot1").empty();
                plotD3("#plot1", mydata, logx, logy, showline, showmarker);
            }
            
            function updateShowLine(ev) {
                var showline = ev.target.checked;
                var target = $(this).parent().parent().find('.jqplot-target')[0].id;
                var showLineOpts = {seriesDefaults: {showLine: showline}};
                $.extend(true, plots[target].options, showLineOpts);
                plots[target].replot(plots[target].options);
            }
            
            function updateShowMarker(ev) {
                var showmarker = ev.target.checked;
                var target = $(this).parent().parent().find('.jqplot-target')[0].id;
                var showMarkerOpts = {seriesDefaults: {showMarker: showmarker}};
                $.extend(true, plots[target].options, showMarkerOpts);
                plots[target].replot(plots[target].options);
            }
            
            function showData(data, plotnum) {
            }
            
            
            window.onload = function() {
                var qsParm = qs();
                var rpc_port = qsParm.rpc_port || 8080;
                $.jsonRPC.setup({
                  //endPoint: 'http://localhost:' + rpc_port + '/RPC2',
                  endPoint: window.location.origin + '/RPC2',
                  namespace: '',
                  cache: false
                });
                $('#scan_directory').click( scan_directory );
                
                createTable('content_table', 1, 1);
                var transform = 'lin';
                var xislog = false;
                var yislog = false;
                var zislog = false;
                var showline = true;
                var showmarker = true;
                $('.transform[axis=xaxis] input').prop('checked', xislog).change(updatePlotOptions);
                $('.transform[axis=yaxis] input').prop('checked', yislog).change(updatePlotOptions);
                $('.transform[axis=zaxis] input').prop('checked', zislog).change(updatePlotOptions);
                $('.showline input').prop('checked', showline).change(updatePlotOptions);
                $('.showmarker input').prop('checked', showmarker).change(updatePlotOptions);
                
                var layout = $('body').layout({
			        west__size:			300
		        ,	east__size:			0
		        ,   south__size:        "auto"
			        // RESIZE Accordion widget when panes resize
		        ,	west__onresize:		$.layout.callbacks.resizePaneAccordions
		        ,	east__onresize:		$.layout.callbacks.resizePaneAccordions
		        ,	south__onresize:	$.layout.callbacks.resizePaneAccordions
		        });
                $('#file_tree')
                  // listen for event
                  //.on('select_node.jstree', function (e, data) {
                  .on('activate_node.jstree', function (e, data) {
                    var i, j, r = [], params = [], c;
                    c = data.instance.get_checked();
                    for(i = 0, j = c.length; i < j; i++) {
                        r.push(data.instance.get_node(c[i]).text);
                    
                        //$('#plot_div').html('Selected: ' + r.join(', '));
                        var node = data.instance.get_node(c[i]);
                        if ('a_attr' in node && 'filename' in node.a_attr) {
                            var path = node.a_attr.path;
                            var filename = node.a_attr.filename;
                            var entry = node.a_attr.entry;
                            params.push({filename:path + "/" + filename, entry:entry});
                        }
                    }
                    if (params.length > 0) {
                        $.jsonRPC.request('get_plottable', { 
                            params: [params],
                            success: function(result) { 
                                //var toPlot = $.extend(true, result.result, standard_plot); 
                                $('#plot1').empty();
                                //$.jqplot('plot_div', result.result.data, result.result.options);
                                //showData(result.result, 1);
                                mydata = result.result;
                                var logx = $('.transform[axis=xaxis] input').prop('checked');
                                var logy = $('.transform[axis=yaxis] input').prop('checked');
                                var showline = $('.showline input').prop('checked');
                                var showmarker = $('.showmarker input').prop('checked');
                                plotD3("#plot1", result.result, logx, logy, showline, showmarker);
                                
                            },
                            error: function(result) { console.log(result); }
                        });
                    } 
                });
            }
        </script>
        <style type="text/css">
            .plotdiv {
                width: 100%;
                height: 100%;
            }
            #plot_table { width: 100%; height: 100% }
            td.plotcell {
                padding: 15px;
            }
        </style>
        <style type="text/css">                    
            body {
              font: 10px sans-serif;
              margin: 50px;
              user-select: none; 
              -webkit-user-select: none; 
              -moz-user-select: none;
            }
             
            .grid .tick {
	            stroke: lightgrey;
	            opacity: 0.7;
	            shape-rendering: crispEdges;
	            user-select: none; 
	            -webkit-user-select: none; 
	            -moz-user-select: none;
            }
             
            .grid path {
	            stroke-width: 0;
            }
             
            .axis path {
	            fill: none;
	            stroke: #bbb;
	            shape-rendering: crispEdges;
            }
             
            .axis text {
	            fill: #555;
            }
             
            .axis line {	
	            stroke: #e7e7e7;
	            shape-rendering: crispEdges;
            }
             
            .axis .axis-label {
	            font-size: 14px;
	            user-select: none; 
	            -webkit-user-select: none; 
	            -moz-user-select: none;
            }
            
            .legend, .tick {
                user-select: none; 
	            -webkit-user-select: none; 
	            -moz-user-select: none;
            }
             
            .line {
	            fill: none;
	            stroke-width: 1.5px;
            }
            
            .highlight {
                stroke-width: 4.5px;
            }
             
            .dot {
	            /* consider the stroke-with the mouse detect radius? */
	            stroke: transparent;
	            stroke-width: 10px;  
	            cursor: pointer;
            }
             
            .dot:hover {
	            stroke: rgba(68, 127, 255, 0.3);
            }
            
            rect {
              fill: #fff;
              user-select: none; 
	          -webkit-user-select: none; 
	          -moz-user-select: none;
            }

            rect.zoom {
              stroke: steelblue;
              fill-opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <div id="top_panel" class="ui-layout-north"></div>
        <div id="file_panel" class="ui-layout-west">
            <button id="scan_directory">Scan Directory</button>
            <input id="data_path" type="text" width="12" value="testdata"></input>
            <div id="file_tree"></div>
        </div>
        <div id="content_table" class="ui-layout-center"></div>
    </body>
</html>

