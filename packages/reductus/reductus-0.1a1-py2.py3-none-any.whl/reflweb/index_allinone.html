<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>Reflectometry reduction</title>
        <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.11.1.custom/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/jquery.jsonrpc.js"></script>
        <script type="text/javascript" src="js/jstree/dist/jstree.min.js"></script>
        <script type="text/javascript" src="js/jquery.layout-latest.js"></script>
        
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/jquery.jqplot.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.cursor.min.js"></script>
        
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.errorbarRenderer.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.InteractiveLegend.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.FixedAspect.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.GracefulAxisRenderer.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.heatmapRenderer.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.colorbarRenderer.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.set_transform.js"></script>
        
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors_plugin_base.js"></script>
        <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/rectangle_interactor_plugin.js"></script>
        
        <link rel="stylesheet" href="css/layout-default-latest.css" />
        <link rel="stylesheet" href="js/jstree/docs/assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="js/jstree/dist/themes/default/style.min.css"/>
        <link rel="stylesheet" href="js/jquery-ui-1.11.1.custom/jquery-ui.min.css" />
        <link rel="stylesheet" href="js/jquery-ui-1.11.1.custom/jquery-ui.theme.min.css" />
        <link rel="stylesheet" href="js/jquery-ui-1.11.1.custom/jquery-ui.structure.min.css" />
        <script type="text/javascript">
            SORT_KEYS = true;
            
            function qs() {
                var qsParm = {};
                var query = window.location.search.substring(1);
                var parms = query.split('&');
                for (var i=0; i<parms.length; i++) {
                    var pos = parms[i].indexOf('=');
                    if (pos > 0) {
                        var key = parms[i].substring(0,pos);
                        var val = parms[i].substring(pos+1);
                        qsParm[key] = val;
                    }
                }
                return qsParm;
            }
            
            function type (object) {
                if (object === null) {
                    return 'null';
                }
                if (object === undefined) {
                    return 'undefined';
                }
                if ((object instanceof Number) || (typeof object === 'number')) {
                    return 'number';
                }
                if ((object instanceof String) || (typeof object === 'string')) {
                    return 'string';
                }
                if ((object instanceof Boolean) || (typeof object === 'boolean')) {
                    return 'boolean';
                }
                if ((object instanceof RegExp) || (typeof object === 'regexp')) {
                    return 'regexp';
                }
                if (Array.isArray(object)) {
                    return 'array';
                }

                return 'object';
            };
            
            function json_to_jstree(obj, root) {
                var simplenodes = {'string': true, 'boolean': true, 'number': true, 'null': true}
                if (root == true) {
                    return {'core': {'data': json_to_jstree(obj, false)}}
                }
                
                var out;
                if (type(obj) === 'object') {
                    var keys = Object.keys(obj);
                    var val, text;
                    if (SORT_KEYS) { keys.sort(function(a, b){return parseFloat(a)-parseFloat(b)}) }
                    out = [];
                    for (var i=0; i<keys.length; i++) {
                        val = obj[keys[i]];
                        if (type(val) in simplenodes) {
                            out.push({'text': '<b>'+ keys[i] + ':</b> ' + String(val), 'icon': "glyphicon glyphicon-chevron-right"});
                        } else {
                            out.push({'text': keys[i], 'children': json_to_jstree(obj[keys[i]]) });
                        }
                    }        
                }
                else if( type(obj) === 'array' ) {
                    out = [];
                    for (var i=0; i<obj.length; i++) {
                        out.push(json_to_jstree(obj[i]));
                    }
                }
                else if( type(obj) === 'string') {
                    out = {'text': obj, 'icon': "glyphicon glyphicon-chevron-right"};
                }
                else if( type(obj) === 'number') {
                    out = {'text': obj.toString(), 'icon': "glyphicon glyphicon-chevron-right" };
                }
                else { 
                    out = {'text': 'unknown'};
                    //alert( 'not a known type: ', String(obj) );
                }
                return out;
            }
            
            standard_plot = {
                options: { 
                    axesDefaults: {
                        renderer: $.jqplot.GracefulAxisRenderer,
                        labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                        tickRenderer: $.jqplot.CanvasAxisTickRenderer,
                        tickOptions: {
                            formatString: "%.2g",
                            _styles: {right:2}
                        }                    
                    },
                    seriesDefaults: {
                        // update options with values from checkboxes:
                        showLine: true,
                        showMarker: true,
                        // 
                        shadow: false, 
                        markerOptions: {shadow: false, size: 8},
                        breakOnNull: true, 
                        label: "series"
                    },
                    cursor: { show: true,  zoom: true, clickReset: true, useAxesFormatters: false},
                    legend: {
                        show: true,
                        parent: this,
                        placement: 'ne',
                        renderer: $.jqplot.InteractiveLegendRenderer
                    },
                    grid: {shadow: false},
                    sortData: false,
                    transform: {'yaxis': 'log'}
                }
            }
            
            scan_directory = function(event, path) {
                var path = path || $('#data_path').val();
                //$.jsonRPC.request('categorize_files', { 
                //$.jsonRPC.request('get_jstree', {
                $.jsonRPC.request('get_file_metadata', {
                    params: [path], 
                    success: function(result) {
                        //file_list = result.result;
                        //tree_version = json_to_jstree(file_list, true);
                        var metadata = result.result;
                        var categorized_files = categorize_files(metadata);
                        var tree_version = make_jstree(categorized_files, true);
                        $('#file_tree').jstree(tree_version);
                    }, 
                    error: function(result) {console.log('error: ', result)}
                });
            }
            
            categorize_files = function(metadata) {
                // metadata is list of file information, 
                // [{'filename': ...}, {'filename': ...} ...]
                
                var output = {}, item, name, num, scanType, entry, newid, d;
                for (var i=0; i<metadata.length; i++) {
                    item = metadata[i];
                    d = {};
                    if (!(item.sample_name in output)) {
                        output[item.sample_name] = {};
                    }
                    if (!(item.scanType in output[item.sample_name])) {
                        output[item.sample_name][item.scanType] = {};
                    }
                    newid = item.fileNum + ":" + item.entry
                    output[item.sample_name][item.scanType][newid] = {path: item.path, filename: item.filename, entry: item.entry};
                }
                return output
            }
            
            make_jstree = function(categorized, sort_keys) {
                // categorized is a JS object with structure sample name -> scanType -> [filenum + entryname]  
                // [{'filename': ...}, {'filename': ...} ...]
                var output = {'core': {'data': []}};
                var names = Object.keys(categorized);
                if (sort_keys) { names.sort(); }
                var ndata, name;
                var scanTypes, scanType, sdata;
                var entries, entry, edata;
                for (var i=0; i<names.length; i++) {
                    name = names[i];
                    namedata = categorized[name];
                    var n_out = {"text": name, "children": []};
                    scanTypes = Object.keys(namedata);
                    if (sort_keys) { scanTypes.sort(); }
                    for (var j=0; j<scanTypes.length; j++) {
                        scanType = scanTypes[j];
                        sdata = namedata[scanType];
                        var s_out = {"text": scanType, "children": []};
                        entries = Object.keys(sdata);                        
                        for (var k=0; k<entries.length; k++) {
                            entry = entries[k];
                            edata = sdata[entry];
                            var e_out = {
                                "text": entry, 
                                "icon": "glyphicon glyphicon-chevron-right", 
                                "a_attr": {
                                    "filename": edata.filename,
                                    "path": edata.path,
                                    "entry": edata.entry
                                }        
                            }
                            s_out.children.push(e_out);
                        }
                        n_out.children.push(s_out);
                    }
                    output.core.data.push(n_out);
                }
                return output;
            }
            
            dirHelper = "http://ncnr.nist.gov/instruments/magik/listftpfiles.php";
            
            getftp = function(path) {
                $.post(dirHelper, {'pathlist': path}, function(r) { ftplist = r; console.log(r); });
            }
            
            //$.post(dirHelper, {'pathlist': data_path}, updateFileBrowserPane("navigation", data_path));
            
            window.onload = function() {
                var qsParm = qs();
                var rpc_port = qsParm.rpc_port || 8080;
                $.jsonRPC.setup({
                  //endPoint: 'http://localhost:' + rpc_port + '/RPC2',
                  endPoint: window.location.origin + '/RPC2',
                  namespace: '',
                  cache: false
                });
                $('#scan_directory').click( scan_directory );
                
                var layout = $('body').layout({
			        west__size:			300
		        ,	east__size:			0
		        ,   south__size:        "auto"
			        // RESIZE Accordion widget when panes resize
		        ,	west__onresize:		$.layout.callbacks.resizePaneAccordions
		        ,	east__onresize:		$.layout.callbacks.resizePaneAccordions
		        ,	south__onresize:	$.layout.callbacks.resizePaneAccordions
		        });
                $('#file_tree')
                  // listen for event
                  .on('select_node.jstree', function (e, data) {
                    var i, j, r = [], params = [];
                    for(i = 0, j = data.selected.length; i < j; i++) {
                        r.push(data.instance.get_node(data.selected[i]).text);
                    
                        //$('#plot_div').html('Selected: ' + r.join(', '));
                        var node = data.instance.get_node(data.selected[i]);
                        if ('a_attr' in node && 'filename' in node.a_attr) {
                            var path = node.a_attr.path;
                            var filename = node.a_attr.filename;
                            var entry = node.a_attr.entry;
                            params.push({filename:path + "/" + filename, entry:entry});
                        }
                    }
                    if (params.length > 0) {
                        $.jsonRPC.request('get_plottable', { 
                            params: [params],
                            success: function(result) { 
                                var toPlot = $.extend(true, result.result, standard_plot); 
                                $('#plot_div').empty(); 
                                $.jqplot('plot_div', result.result.data, result.result.options) 
                            },
                            error: function(result) { console.log(result); }
                        });
                    }  
                });
            }
        </script>
    </head>
    <body>
        <div id="top_panel" class="ui-layout-north">
            <button id="scan_directory">Scan Directory</button>
            <input id="data_path" type="text" width="20" value="testdata"></input>
        </div>
        <div id="file_tree" class="ui-layout-west">files</div>
        <div id="plot_div" class="ui-layout-center"></div>
    </body>
</html>

