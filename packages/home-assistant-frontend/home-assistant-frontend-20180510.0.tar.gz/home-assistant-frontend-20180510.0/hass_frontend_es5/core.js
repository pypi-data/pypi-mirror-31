!function(){"use strict";var f=1,l=2;function s(t,d){return console.log("[Auth phase] Initializing",t),new Promise(function(e,n){return function o(s,i,r){console.log("[Auth Phase] New connection",t);var c=new WebSocket(t),a=!1,u=function e(n){if(c.removeEventListener("close",e),a)r(l);else if(0!==s){var t=-1===s?-1:s-1;setTimeout(function(){return o(t,i,r)},1e3)}else r(f)};c.addEventListener("message",function e(n){var t=JSON.parse(n.data);switch(console.log("[Auth phase] Received",t),t.type){case"auth_required":d.authToken?c.send(JSON.stringify({type:"auth",api_password:d.authToken})):d.accessToken?c.send(JSON.stringify({type:"auth",access_token:d.accessToken})):(a=!0,c.close());break;case"auth_invalid":a=!0,c.close();break;case"auth_ok":c.removeEventListener("message",e),c.removeEventListener("close",u),c.removeEventListener("error",u),i(c);break;default:console.warn("[Auth phase] Unhandled message",t)}}),c.addEventListener("close",u),c.addEventListener("error",u)}(d.setupRetry||0,e,n)})}function e(e){return e.result}var i=function(e,n){this.url=e,this.options=n||{},this.commandId=1,this.commands={},this.eventListeners={},this.closeRequested=!1,this._handleMessage=this._handleMessage.bind(this),this._handleClose=this._handleClose.bind(this)};function r(t,o){return void 0===o&&(o={}),s(t,o).then(function(e){var n=new i(t,o);return n.setSocket(e),n})}function c(f,l){return f._subscribeConfig?f._subscribeConfig(l):new Promise(function(s,e){var r=null,i=null,t=[],n=null;l&&t.push(l);var c=function(e){r=Object.assign({},r,e);for(var n=0;n<t.length;n++)t[n](r)},a=function(e,n){return c({services:Object.assign({},r.services,(t={},t[e]=n,t))});var t},u=function(){return Promise.all([f.getConfig(),f.getPanels(),f.getServices()]).then(function(e){var n=e[0],t=e[1],o=e[2];c({core:n,panels:t,services:o})})},d=function(e){e&&t.splice(t.indexOf(e),1),0===t.length&&i()};f._subscribeConfig=function(e){return e&&(t.push(e),null!==r&&e(r)),n.then(function(){return function(){return d(e)}})},(n=Promise.all([f.subscribeEvents(function(e){if(null!==r){var n=Object.assign({},r.core,{components:r.core.components.concat(e.data.component)});c({core:n})}},"component_loaded"),f.subscribeEvents(function(e){if(null!==r){var n,t=e.data,o=t.domain,s=t.service,i=Object.assign({},r.services[o]||{},((n={})[s]={description:"",fields:{}},n));a(o,i)}},"service_registered"),f.subscribeEvents(function(e){if(null!==r){var n=e.data,t=n.domain,o=n.service,s=r.services[t];if(s&&o in s){var i={};Object.keys(s).forEach(function(e){e!==o&&(i[e]=s[e])}),a(t,i)}}},"service_removed"),u()])).then(function(e){var n=e[0],t=e[1],o=e[2];i=function(){removeEventListener("ready",u),n(),t(),o()},f.addEventListener("ready",u),s(function(){return d(l)})},function(){return e()})})}function a(r,c){return r._subscribeEntities?r._subscribeEntities(c):new Promise(function(t,e){var f=null,o=null,l=[],n=null;function s(){return r.getStates().then(function(e){f=function(e){for(var n={},t=0;t<e.length;t++){var o=e[t];n[o.entity_id]=o}return n}(e);for(var n=0;n<l.length;n++)l[n](f)})}function i(e){e&&l.splice(l.indexOf(e),1),0===l.length&&(o(),r.removeEventListener("ready",s),r._subscribeEntities=null)}c&&l.push(c),r._subscribeEntities=function(e){return e&&(l.push(e),null!==f&&e(f)),n.then(function(){return function(){return i(e)}})},(n=Promise.all([r.subscribeEvents(function(e){if(null!==f){var n,t,o,s,i,r,c=e.data,a=c.entity_id,u=c.new_state;u?(s=f,i=u,(r=Object.assign({},s))[i.entity_id]=i,f=r):(n=f,t=a,delete(o=Object.assign({},n))[t],f=o);for(var d=0;d<l.length;d++)l[d](f)}},"state_changed"),s()])).then(function(e){var n=e[0];o=n,r.addEventListener("ready",s),t(function(){return i(c)})},function(){return e()})})}function u(e){return e.substr(0,e.indexOf("."))}function d(t,e){var o={};return e.attributes.entity_id.forEach(function(e){var n=t[e];n&&(o[n.entity_id]=n)}),o}i.prototype.setSocket=function(e){var t=this,n=this.socket;if((this.socket=e).addEventListener("message",this._handleMessage),e.addEventListener("close",this._handleClose),n){var o=this.commands;this.commandId=1,this.commands={},Object.keys(o).forEach(function(e){var n=o[e];n.eventType&&t.subscribeEvents(n.eventCallback,n.eventType).then(function(e){n.unsubscribe=e})}),this.fireEvent("ready")}},i.prototype.addEventListener=function(e,n){var t=this.eventListeners[e];t||(t=this.eventListeners[e]=[]),t.push(n)},i.prototype.removeEventListener=function(e,n){var t=this.eventListeners[e];if(t){var o=t.indexOf(n);-1!==o&&t.splice(o,1)}},i.prototype.fireEvent=function(e,n){var t=this;(this.eventListeners[e]||[]).forEach(function(e){return e(t,n)})},i.prototype.close=function(){this.closeRequested=!0,this.socket.close()},i.prototype.getStates=function(){return this.sendMessagePromise({type:"get_states"}).then(e)},i.prototype.getServices=function(){return this.sendMessagePromise({type:"get_services"}).then(e)},i.prototype.getPanels=function(){return this.sendMessagePromise({type:"get_panels"}).then(e)},i.prototype.getConfig=function(){return this.sendMessagePromise({type:"get_config"}).then(e)},i.prototype.callService=function(e,n,t){return this.sendMessagePromise((s={type:"call_service",domain:e,service:n},(o=t)&&(s.service_data=o),s));var o,s},i.prototype.subscribeEvents=function(t,o){var e,n,s=this;return this.sendMessagePromise((e=o,n={type:"subscribe_events"},e&&(n.event_type=e),n)).then(function(n){var e={eventCallback:t,eventType:o,unsubscribe:function(){return s.sendMessagePromise((e=n.id,{type:"unsubscribe_events",subscription:e})).then(function(){delete s.commands[n.id]});var e}};return s.commands[n.id]=e,function(){return e.unsubscribe()}})},i.prototype.ping=function(){return this.sendMessagePromise({type:"ping"})},i.prototype.sendMessage=function(e){console.log("Sending",e),this.socket.send(JSON.stringify(e))},i.prototype.sendMessagePromise=function(o){var s=this;return new Promise(function(e,n){s.commandId+=1;var t=s.commandId;o.id=t,s.commands[t]={resolve:e,reject:n},s.sendMessage(o)})},i.prototype._handleMessage=function(e){var n=JSON.parse(e.data);switch(console.log("Received",n),n.type){case"event":this.commands[n.id].eventCallback(n.event);break;case"result":n.success?this.commands[n.id].resolve(n):this.commands[n.id].reject(n.error),delete this.commands[n.id];break;case"pong":break;default:console.warn("Unhandled message",n)}},i.prototype._handleClose=function(){var o=this;if(Object.keys(this.commands).forEach(function(e){var n,t=o.commands[e].reject;t&&t({type:"result",success:!(n="Connection lost"),error:{code:3,message:n}})}),!this.closeRequested){this.fireEvent("disconnected");var e=Object.assign({},this.options,{setupRetry:0});!function n(t){setTimeout(function(){console.log("Trying to reconnect"),s(o.url,e).then(function(e){return o.setSocket(e)},function(e){return e===l?o.fireEvent("reconnect-error",e):n(t+1)})},1e3*Math.min(t,5))}(0)}};var h="group.default_view";var n=Object.freeze({ERR_CANNOT_CONNECT:f,ERR_INVALID_AUTH:l,createConnection:r,subscribeConfig:c,subscribeEntities:a,getGroupEntities:d,splitByGroups:function(t){var o=[],s={};return Object.keys(t).forEach(function(e){var n=t[e];"group"===u(e)?o.push(n):s[e]=n}),o.forEach(function(e){return e.attributes.entity_id.forEach(function(e){delete s[e]})}),{groups:o,ungrouped:s}},getViewEntities:function(o,e){var s={};return e.attributes.entity_id.forEach(function(e){var n=o[e];if(n&&!n.attributes.hidden&&"group"===u((s[n.entity_id]=n).entity_id)){var t=d(o,n);Object.keys(t).forEach(function(e){var n=t[e];n.attributes.hidden||(s[e]=n)})}}),s},extractViews:function(t){var o=[];return Object.keys(t).forEach(function(e){var n=t[e];n.attributes.view&&o.push(n)}),o.sort(function(e,n){return e.entity_id===h?-1:n.entity_id===h?1:e.attributes.order-n.attributes.order}),o},extractDomain:u,extractObjectId:function(e){return e.substr(e.indexOf(".")+1)}});window.HAWS=n,window.HASS_DEMO=!1,window.HASS_DEV=!1,window.HASS_BUILD="es5",window.HASS_VERSION="20180510.0";var t=window.createHassConnection=function(e,n){var t=("https:"===window.location.protocol?"wss":"ws")+"://"+window.location.host+"/api/websocket?"+window.HASS_BUILD,o={setupRetry:10};return e?o.authToken=e:n&&(o.accessToken=n),r(t,o).then(function(e){return a(e),c(e),e})};function v(){document.location="/frontend_es5/authorize.html?response_type=code&client_id="+window.clientId+"&redirect_uri=/"}function o(e){var n,t,o;(n=window.clientId,t=e,o=new FormData,o.append("grant_type","authorization_code"),o.append("code",t),fetch("/auth/token",{method:"POST",headers:{authorization:"Basic "+btoa(n)},body:o}).then(function(e){if(!e.ok)throw new Error("Unable to fetch tokens");return e.json()})).then(function(e){localStorage.tokens=JSON.stringify(e),document.location=location.pathname},function(e){console.error("Resolve token failed",e),alert("Unable to fetch tokens"),v()})}window.refreshToken=function(){return(e=window.clientId,n=window.tokens.refresh_token,t=new FormData,t.append("grant_type","refresh_token"),t.append("refresh_token",n),fetch("/auth/token",{method:"POST",headers:{authorization:"Basic "+btoa(e)},body:t}).then(function(e){if(!e.ok)throw new Error("Unable to fetch tokens");return e.json()})).then(function(e){return window.tokens.access_token=e.access_token,localStorage.tokens=JSON.stringify(window.tokens),e.access_token},function(){return v()});var e,n,t},window.clientId?function(){if(location.search){var e=function(e){for(var n={},t=e.split("&"),o=0;o<t.length;o++){var s=t[o].split("="),i=decodeURIComponent(s[0]),r=1<s.length?decodeURIComponent(s[1]):void 0;n[i]=r}return n}(location.search.substr(1));if(e.code)return o(e.code)}if(localStorage.tokens)return window.tokens=JSON.parse(localStorage.tokens),window.hassConnection=t(null,window.tokens.access_token).catch(function(e){if(e!==l)throw e;return window.refreshToken().then(function(e){return t(null,e)})});v()}():"1"===window.noAuth?window.hassConnection=t():window.localStorage.authToken?window.hassConnection=t(window.localStorage.authToken):window.hassConnection=null,window.addEventListener("error",function(e){var n=document.querySelector("home-assistant");n&&n.hass&&n.hass.callService&&n.hass.callService("system_log","write",{logger:"frontend."+(window.HASS_DEV?"js_dev":"js")+"."+window.HASS_BUILD+"."+window.HASS_VERSION.replace(".",""),message:e.filename+":"+e.lineno+":"+e.colno+" "+e.message})})}();