!function(){"use strict";var e=1,n=2;function t(t,o){return console.log("[Auth phase] Initializing",t),new Promise(function(s,i){return function s(i,r,c){console.log("[Auth Phase] New connection",t);var a=new WebSocket(t),u=!1,d=function(t){if(a.removeEventListener("close",d),u)c(n);else if(0!==i){var o=-1===i?-1:i-1;setTimeout(function(){return s(o,r,c)},1e3)}else c(e)},l=function(e){var n=JSON.parse(e.data);switch(console.log("[Auth phase] Received",n),n.type){case"auth_required":o.authToken?a.send(JSON.stringify({type:"auth",api_password:o.authToken})):o.accessToken?a.send(JSON.stringify({type:"auth",access_token:o.accessToken})):(u=!0,a.close());break;case"auth_invalid":u=!0,a.close();break;case"auth_ok":a.removeEventListener("message",l),a.removeEventListener("close",d),a.removeEventListener("error",d),r(a);break;default:console.warn("[Auth phase] Unhandled message",n)}};a.addEventListener("message",l),a.addEventListener("close",d),a.addEventListener("error",d)}(o.setupRetry||0,s,i)})}function o(e){return e.result}var s=function(e,n){this.url=e,this.options=n||{},this.commandId=1,this.commands={},this.eventListeners={},this.closeRequested=!1,this._handleMessage=this._handleMessage.bind(this),this._handleClose=this._handleClose.bind(this)};function i(e,n){return void 0===n&&(n={}),t(e,n).then(function(t){var o=new s(e,n);return o.setSocket(t),o})}function r(e,n){return e._subscribeConfig?e._subscribeConfig(n):new Promise(function(t,o){var s=null,i=null,r=[],c=null;n&&r.push(n);var a=function(e){s=Object.assign({},s,e);for(var n=0;n<r.length;n++)r[n](s)},u=function(e,n){return a({services:Object.assign({},s.services,(t={},t[e]=n,t))});var t},d=function(){return Promise.all([e.getConfig(),e.getPanels(),e.getServices()]).then(function(e){var n=e[0],t=e[1],o=e[2];a({core:n,panels:t,services:o})})},l=function(e){e&&r.splice(r.indexOf(e),1),0===r.length&&i()};e._subscribeConfig=function(e){return e&&(r.push(e),null!==s&&e(s)),c.then(function(){return function(){return l(e)}})},(c=Promise.all([e.subscribeEvents(function(e){if(null!==s){var n=Object.assign({},s.core,{components:s.core.components.concat(e.data.component)});a({core:n})}},"component_loaded"),e.subscribeEvents(function(e){if(null!==s){var n,t=e.data,o=t.domain,i=t.service,r=Object.assign({},s.services[o]||{},((n={})[i]={description:"",fields:{}},n));u(o,r)}},"service_registered"),e.subscribeEvents(function(e){if(null!==s){var n=e.data,t=n.domain,o=n.service,i=s.services[t];if(i&&o in i){var r={};Object.keys(i).forEach(function(e){e!==o&&(r[e]=i[e])}),u(t,r)}}},"service_removed"),d()])).then(function(o){var s=o[0],r=o[1],c=o[2];i=function(){removeEventListener("ready",d),s(),r(),c()},e.addEventListener("ready",d),t(function(){return l(n)})},function(){return o()})})}function c(e,n){return e._subscribeEntities?e._subscribeEntities(n):new Promise(function(t,o){var s=null,i=null,r=[],c=null;function a(){return e.getStates().then(function(e){s=function(e){for(var n={},t=0;t<e.length;t++){var o=e[t];n[o.entity_id]=o}return n}(e);for(var n=0;n<r.length;n++)r[n](s)})}function u(n){n&&r.splice(r.indexOf(n),1),0===r.length&&(i(),e.removeEventListener("ready",a),e._subscribeEntities=null)}n&&r.push(n),e._subscribeEntities=function(e){return e&&(r.push(e),null!==s&&e(s)),c.then(function(){return function(){return u(e)}})},(c=Promise.all([e.subscribeEvents(function(e){if(null!==s){var n=e.data,t=n.entity_id,o=n.new_state;s=o?function(e,n){var t=Object.assign({},e);return t[n.entity_id]=n,t}(s,o):function(e,n){var t=Object.assign({},e);return delete t[n],t}(s,t);for(var i=0;i<r.length;i++)r[i](s)}},"state_changed"),a()])).then(function(o){var s=o[0];i=s,e.addEventListener("ready",a),t(function(){return u(n)})},function(){return o()})})}function a(e){return e.substr(0,e.indexOf("."))}function u(e,n){var t={};return n.attributes.entity_id.forEach(function(n){var o=e[n];o&&(t[o.entity_id]=o)}),t}s.prototype.setSocket=function(e){var n=this,t=this.socket;if(this.socket=e,e.addEventListener("message",this._handleMessage),e.addEventListener("close",this._handleClose),t){var o=this.commands;this.commandId=1,this.commands={},Object.keys(o).forEach(function(e){var t=o[e];t.eventType&&n.subscribeEvents(t.eventCallback,t.eventType).then(function(e){t.unsubscribe=e})}),this.fireEvent("ready")}},s.prototype.addEventListener=function(e,n){var t=this.eventListeners[e];t||(t=this.eventListeners[e]=[]),t.push(n)},s.prototype.removeEventListener=function(e,n){var t=this.eventListeners[e];if(t){var o=t.indexOf(n);-1!==o&&t.splice(o,1)}},s.prototype.fireEvent=function(e,n){var t=this;(this.eventListeners[e]||[]).forEach(function(e){return e(t,n)})},s.prototype.close=function(){this.closeRequested=!0,this.socket.close()},s.prototype.getStates=function(){return this.sendMessagePromise({type:"get_states"}).then(o)},s.prototype.getServices=function(){return this.sendMessagePromise({type:"get_services"}).then(o)},s.prototype.getPanels=function(){return this.sendMessagePromise({type:"get_panels"}).then(o)},s.prototype.getConfig=function(){return this.sendMessagePromise({type:"get_config"}).then(o)},s.prototype.callService=function(e,n,t){return this.sendMessagePromise(function(e,n,t){var o={type:"call_service",domain:e,service:n};return t&&(o.service_data=t),o}(e,n,t))},s.prototype.subscribeEvents=function(e,n){var t=this;return this.sendMessagePromise(function(e){var n={type:"subscribe_events"};return e&&(n.event_type=e),n}(n)).then(function(o){var s={eventCallback:e,eventType:n,unsubscribe:function(){return t.sendMessagePromise((e=o.id,{type:"unsubscribe_events",subscription:e})).then(function(){delete t.commands[o.id]});var e}};return t.commands[o.id]=s,function(){return s.unsubscribe()}})},s.prototype.ping=function(){return this.sendMessagePromise({type:"ping"})},s.prototype.sendMessage=function(e){console.log("Sending",e),this.socket.send(JSON.stringify(e))},s.prototype.sendMessagePromise=function(e){var n=this;return new Promise(function(t,o){n.commandId+=1;var s=n.commandId;e.id=s,n.commands[s]={resolve:t,reject:o},n.sendMessage(e)})},s.prototype._handleMessage=function(e){var n=JSON.parse(e.data);switch(console.log("Received",n),n.type){case"event":this.commands[n.id].eventCallback(n.event);break;case"result":n.success?this.commands[n.id].resolve(n):this.commands[n.id].reject(n.error),delete this.commands[n.id];break;case"pong":break;default:console.warn("Unhandled message",n)}},s.prototype._handleClose=function(){var e=this;if(Object.keys(this.commands).forEach(function(n){var t=e.commands[n].reject;t&&t({type:"result",success:!1,error:{code:3,message:"Connection lost"}})}),!this.closeRequested){this.fireEvent("disconnected");var o=Object.assign({},this.options,{setupRetry:0}),s=function(i){setTimeout(function(){console.log("Trying to reconnect"),t(e.url,o).then(function(n){return e.setSocket(n)},function(t){return t===n?e.fireEvent("reconnect-error",t):s(i+1)})},1e3*Math.min(i,5))};s(0)}};var d="group.default_view";var l=Object.freeze({ERR_CANNOT_CONNECT:e,ERR_INVALID_AUTH:n,createConnection:i,subscribeConfig:r,subscribeEntities:c,getGroupEntities:u,splitByGroups:function(e){var n=[],t={};return Object.keys(e).forEach(function(o){var s=e[o];"group"===a(o)?n.push(s):t[o]=s}),n.forEach(function(e){return e.attributes.entity_id.forEach(function(e){delete t[e]})}),{groups:n,ungrouped:t}},getViewEntities:function(e,n){var t={};return n.attributes.entity_id.forEach(function(n){var o=e[n];if(o&&!o.attributes.hidden&&(t[o.entity_id]=o,"group"===a(o.entity_id))){var s=u(e,o);Object.keys(s).forEach(function(e){var n=s[e];n.attributes.hidden||(t[e]=n)})}}),t},extractViews:function(e){var n=[];return Object.keys(e).forEach(function(t){var o=e[t];o.attributes.view&&n.push(o)}),n.sort(function(e,n){return e.entity_id===d?-1:n.entity_id===d?1:e.attributes.order-n.attributes.order}),n},extractDomain:a,extractObjectId:function(e){return e.substr(e.indexOf(".")+1)}});window.HAWS=l,window.HASS_DEMO=!1,window.HASS_DEV=!1,window.HASS_BUILD="latest",window.HASS_VERSION="20180510.0";const f=window.createHassConnection=function(e,n){const t=`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/api/websocket?${window.HASS_BUILD}`,o={setupRetry:10};return e?o.authToken=e:n&&(o.accessToken=n),i(t,o).then(function(e){return c(e),r(e),e})};function h(){document.location=`/frontend_latest/authorize.html?response_type=code&client_id=${window.clientId}&redirect_uri=/`}function v(e){(function(e,n){const t=new FormData;return t.append("grant_type","authorization_code"),t.append("code",n),fetch("/auth/token",{method:"POST",headers:{authorization:`Basic ${btoa(e)}`},body:t}).then(e=>{if(!e.ok)throw new Error("Unable to fetch tokens");return e.json()})})(window.clientId,e).then(e=>{localStorage.tokens=JSON.stringify(e),document.location=location.pathname},e=>{console.error("Resolve token failed",e),alert("Unable to fetch tokens"),h()})}window.refreshToken=(()=>(function(e,n){const t=new FormData;return t.append("grant_type","refresh_token"),t.append("refresh_token",n),fetch("/auth/token",{method:"POST",headers:{authorization:`Basic ${btoa(e)}`},body:t}).then(e=>{if(!e.ok)throw new Error("Unable to fetch tokens");return e.json()})})(window.clientId,window.tokens.refresh_token).then(e=>(window.tokens.access_token=e.access_token,localStorage.tokens=JSON.stringify(window.tokens),e.access_token),()=>h())),window.clientId?function(){if(location.search){const e=function(e){const n={},t=e.split("&");for(let e=0;e<t.length;e++){const o=t[e].split("="),s=decodeURIComponent(o[0]),i=o.length>1?decodeURIComponent(o[1]):void 0;n[s]=i}return n}(location.search.substr(1));if(e.code)return void v(e.code)}if(localStorage.tokens)return window.tokens=JSON.parse(localStorage.tokens),void(window.hassConnection=f(null,window.tokens.access_token).catch(e=>{if(e!==n)throw e;return window.refreshToken().then(e=>f(null,e))}));h()}():"1"===window.noAuth?window.hassConnection=f():window.localStorage.authToken?window.hassConnection=f(window.localStorage.authToken):window.hassConnection=null,window.addEventListener("error",e=>{const n=document.querySelector("home-assistant");n&&n.hass&&n.hass.callService&&n.hass.callService("system_log","write",{logger:`frontend.${window.HASS_DEV?"js_dev":"js"}.${window.HASS_BUILD}.${window.HASS_VERSION.replace(".","")}`,message:`${e.filename}:${e.lineno}:${e.colno} ${e.message}`})})}();