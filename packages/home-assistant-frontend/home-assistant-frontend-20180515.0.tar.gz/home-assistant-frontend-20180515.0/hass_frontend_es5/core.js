!function(){"use strict";var f=1,h=2;function o(u,d){return new Promise(function(e,t){return function n(s,o,i){var r=new WebSocket(u),c=!1,a=function e(){if(r.removeEventListener("close",e),c)i(h);else if(0!==s){var t=-1===s?-1:s-1;setTimeout(function(){return n(t,o,i)},1e3)}else i(f)};r.addEventListener("message",function e(t){switch(JSON.parse(t.data).type){case"auth_required":d.authToken?r.send(JSON.stringify({type:"auth",api_password:d.authToken})):d.accessToken?r.send(JSON.stringify({type:"auth",access_token:d.accessToken})):(c=!0,r.close());break;case"auth_invalid":c=!0,r.close();break;case"auth_ok":r.removeEventListener("message",e),r.removeEventListener("close",a),r.removeEventListener("error",a),o(r)}}),r.addEventListener("close",a),r.addEventListener("error",a)}(d.setupRetry||0,e,t)})}function e(e){return e.result}var i=function(e,t){this.url=e,this.options=t||{},this.commandId=1,this.commands={},this.eventListeners={},this.closeRequested=!1,this._handleMessage=this._handleMessage.bind(this),this._handleClose=this._handleClose.bind(this)};function r(n,s){return void 0===s&&(s={}),o(n,s).then(function(e){var t=new i(n,s);return t.setSocket(e),t})}function c(f,h){return f._subscribeConfig?f._subscribeConfig(h):new Promise(function(o,e){var r=null,i=null,n=[],t=null;h&&n.push(h);var c=function(e){r=Object.assign({},r,e);for(var t=0;t<n.length;t++)n[t](r)},a=function(e,t){return c({services:Object.assign({},r.services,(n={},n[e]=t,n))});var n},u=function(){return Promise.all([f.getConfig(),f.getPanels(),f.getServices()]).then(function(e){var t=e[0],n=e[1],s=e[2];c({core:t,panels:n,services:s})})},d=function(e){e&&n.splice(n.indexOf(e),1),0===n.length&&i()};f._subscribeConfig=function(e){return e&&(n.push(e),null!==r&&e(r)),t.then(function(){return function(){return d(e)}})},(t=Promise.all([f.subscribeEvents(function(e){if(null!==r){var t=Object.assign({},r.core,{components:r.core.components.concat(e.data.component)});c({core:t})}},"component_loaded"),f.subscribeEvents(function(e){if(null!==r){var t,n=e.data,s=n.domain,o=n.service,i=Object.assign({},r.services[s]||{},((t={})[o]={description:"",fields:{}},t));a(s,i)}},"service_registered"),f.subscribeEvents(function(e){if(null!==r){var t=e.data,n=t.domain,s=t.service,o=r.services[n];if(o&&s in o){var i={};Object.keys(o).forEach(function(e){e!==s&&(i[e]=o[e])}),a(n,i)}}},"service_removed"),u()])).then(function(e){var t=e[0],n=e[1],s=e[2];i=function(){removeEventListener("ready",u),t(),n(),s()},f.addEventListener("ready",u),o(function(){return d(h)})},function(){return e()})})}function a(r,c){return r._subscribeEntities?r._subscribeEntities(c):new Promise(function(n,e){function s(){return r.getStates().then(function(e){f=function(e){for(var t,n={},s=0;s<e.length;s++)n[(t=e[s]).entity_id]=t;return n}(e);for(var t=0;t<h.length;t++)h[t](f)})}function o(e){e&&h.splice(h.indexOf(e),1),0===h.length&&(i(),r.removeEventListener("ready",s),r._subscribeEntities=null)}var f=null,i=null,h=[],t=null;c&&h.push(c),r._subscribeEntities=function(e){return e&&(h.push(e),null!==f&&e(f)),t.then(function(){return function(){return o(e)}})},(t=Promise.all([r.subscribeEvents(function(e){if(null!=f){var t=e.data,n=t.entity_id,s=t.new_state;f=s?(a=f,u=s,(d=Object.assign({},a))[u.entity_id]=u,d):(i=f,r=n,delete(c=Object.assign({},i))[r],c);for(var o=0;o<h.length;o++)h[o](f)}var i,r,c,a,u,d},"state_changed"),s()])).then(function(e){var t=e[0];i=t,r.addEventListener("ready",s),n(function(){return o(c)})},function(){return e()})})}function u(e){return e.substr(0,e.indexOf("."))}function d(n,e){var s={};return e.attributes.entity_id.forEach(function(e){var t=n[e];t&&(s[t.entity_id]=t)}),s}i.prototype.setSocket=function(e){var n=this,t=this.socket;if((this.socket=e).addEventListener("message",this._handleMessage),e.addEventListener("close",this._handleClose),t){var s=this.commands;this.commandId=1,this.commands={},Object.keys(s).forEach(function(e){var t=s[e];t.eventType&&n.subscribeEvents(t.eventCallback,t.eventType).then(function(e){t.unsubscribe=e})}),this.fireEvent("ready")}},i.prototype.addEventListener=function(e,t){var n=this.eventListeners[e];n||(n=this.eventListeners[e]=[]),n.push(t)},i.prototype.removeEventListener=function(e,t){var n=this.eventListeners[e];if(n){var s=n.indexOf(t);-1!==s&&n.splice(s,1)}},i.prototype.fireEvent=function(e,t){var n=this;(this.eventListeners[e]||[]).forEach(function(e){return e(n,t)})},i.prototype.close=function(){this.closeRequested=!0,this.socket.close()},i.prototype.getStates=function(){return this.sendMessagePromise({type:"get_states"}).then(e)},i.prototype.getServices=function(){return this.sendMessagePromise({type:"get_services"}).then(e)},i.prototype.getPanels=function(){return this.sendMessagePromise({type:"get_panels"}).then(e)},i.prototype.getConfig=function(){return this.sendMessagePromise({type:"get_config"}).then(e)},i.prototype.callService=function(e,t,n){return this.sendMessagePromise((o={type:"call_service",domain:e,service:t},(s=n)&&(o.service_data=s),o));var s,o},i.prototype.subscribeEvents=function(n,s){var e,t,o=this;return this.sendMessagePromise((e=s,t={type:"subscribe_events"},e&&(t.event_type=e),t)).then(function(t){var e={eventCallback:n,eventType:s,unsubscribe:function(){return o.sendMessagePromise((e=t.id,{type:"unsubscribe_events",subscription:e})).then(function(){delete o.commands[t.id]});var e}};return o.commands[t.id]=e,function(){return e.unsubscribe()}})},i.prototype.ping=function(){return this.sendMessagePromise({type:"ping"})},i.prototype.sendMessage=function(e){this.socket.send(JSON.stringify(e))},i.prototype.sendMessagePromise=function(s){var o=this;return new Promise(function(e,t){o.commandId+=1;var n=o.commandId;s.id=n,o.commands[n]={resolve:e,reject:t},o.sendMessage(s)})},i.prototype._handleMessage=function(e){var t=JSON.parse(e.data);switch(t.type){case"event":this.commands[t.id].eventCallback(t.event);break;case"result":t.success?this.commands[t.id].resolve(t):this.commands[t.id].reject(t.error),delete this.commands[t.id]}},i.prototype._handleClose=function(){var s=this;if(Object.keys(this.commands).forEach(function(e){var t,n=s.commands[e].reject;n&&n({type:"result",success:!(t="Connection lost"),error:{code:3,message:t}})}),!this.closeRequested){this.fireEvent("disconnected");var e=Object.assign({},this.options,{setupRetry:0});!function t(n){setTimeout(function(){o(s.url,e).then(function(e){return s.setSocket(e)},function(e){return e===h?s.fireEvent("reconnect-error",e):t(n+1)})},1e3*Math.min(n,5))}(0)}};var l="group.default_view";var t=Object.freeze({ERR_CANNOT_CONNECT:f,ERR_INVALID_AUTH:h,createConnection:r,subscribeConfig:c,subscribeEntities:a,getGroupEntities:d,splitByGroups:function(n){var s=[],o={};return Object.keys(n).forEach(function(e){var t=n[e];"group"===u(e)?s.push(t):o[e]=t}),s.forEach(function(e){return e.attributes.entity_id.forEach(function(e){delete o[e]})}),{groups:s,ungrouped:o}},getViewEntities:function(s,e){var o={};return e.attributes.entity_id.forEach(function(e){var t=s[e];if(t&&!t.attributes.hidden&&"group"===u((o[t.entity_id]=t).entity_id)){var n=d(s,t);Object.keys(n).forEach(function(e){var t=n[e];t.attributes.hidden||(o[e]=t)})}}),o},extractViews:function(n){var s=[];return Object.keys(n).forEach(function(e){var t=n[e];t.attributes.view&&s.push(t)}),s.sort(function(e,t){return e.entity_id===l?-1:t.entity_id===l?1:e.attributes.order-t.attributes.order}),s},extractDomain:u,extractObjectId:function(e){return e.substr(e.indexOf(".")+1)}});window.HAWS=t,window.HASS_DEMO=!1,window.HASS_DEV=!1,window.HASS_BUILD="es5",window.HASS_VERSION="20180515.0";var n=window.createHassConnection=function(e,t){var n=("https:"===window.location.protocol?"wss":"ws")+"://"+window.location.host+"/api/websocket?"+window.HASS_BUILD,s={setupRetry:10};return e?s.authToken=e:t&&(s.accessToken=t),r(n,s).then(function(e){return a(e),c(e),e})};function v(){document.location="/frontend_es5/authorize.html?response_type=code&client_id="+window.clientId+"&redirect_uri=/"}function s(e){var t,n,s;(t=window.clientId,n=e,s=new FormData,s.append("grant_type","authorization_code"),s.append("code",n),fetch("/auth/token",{method:"POST",headers:{authorization:"Basic "+btoa(t)},body:s}).then(function(e){if(!e.ok)throw new Error("Unable to fetch tokens");return e.json()})).then(function(e){localStorage.tokens=JSON.stringify(e),document.location=location.pathname},function(e){console.error("Resolve token failed",e),alert("Unable to fetch tokens"),v()})}window.refreshToken=function(){return(e=window.clientId,t=window.tokens.refresh_token,n=new FormData,n.append("grant_type","refresh_token"),n.append("refresh_token",t),fetch("/auth/token",{method:"POST",headers:{authorization:"Basic "+btoa(e)},body:n}).then(function(e){if(!e.ok)throw new Error("Unable to fetch tokens");return e.json()})).then(function(e){return window.tokens.access_token=e.access_token,localStorage.tokens=JSON.stringify(window.tokens),e.access_token},function(){return v()});var e,t,n},window.clientId?function(){if(location.search){var e=function(e){for(var t={},n=e.split("&"),s=0;s<n.length;s++){var o=n[s].split("="),i=decodeURIComponent(o[0]),r=1<o.length?decodeURIComponent(o[1]):void 0;t[i]=r}return t}(location.search.substr(1));if(e.code)return s(e.code)}if(localStorage.tokens)return window.tokens=JSON.parse(localStorage.tokens),window.hassConnection=n(null,window.tokens.access_token).catch(function(e){if(e!==h)throw e;return window.refreshToken().then(function(e){return n(null,e)})});v()}():"1"===window.noAuth?window.hassConnection=n():window.localStorage.authToken?window.hassConnection=n(window.localStorage.authToken):window.hassConnection=null,window.addEventListener("error",function(e){var t=document.querySelector("home-assistant");t&&t.hass&&t.hass.callService&&t.hass.callService("system_log","write",{logger:"frontend."+(window.HASS_DEV?"js_dev":"js")+"."+window.HASS_BUILD+"."+window.HASS_VERSION.replace(".",""),message:e.filename+":"+e.lineno+":"+e.colno+" "+e.message})})}();