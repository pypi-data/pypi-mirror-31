(function(){window.PowerPack=window.PowerPack||{};PowerPack.Utils={spaceless:function(strings){var i;for(i=0;i<strings.length;i++){strings[i]=strings[i].trim()}return strings.join("")}};PowerPack.PDF={};PowerPack.PDF.PDF=Backbone.Model.extend({defaults:{pdfURL:"",pdfDocument:null,outlineMap:null},initialize:function(){var self=this,url=this.get("pdfURL");PDFJS.getDocument(url).then(function(pdfDocument){self.set("pdfDocument",pdfDocument);self._initializeNavigationMap(pdfDocument)})},getDocument:function(){var self=this;return new Promise(function(resolve,reject){var pdfDocument=self.get("pdfDocument");if(pdfDocument!==null){resolve(pdfDocument)}else{self.once("change:pdfDocument",function(model,pdfDocument){resolve(pdfDocument)})}})},getPage:function(pageNum){return this.getDocument().then(function(document){return document.getPage(pageNum)})},_initializeNavigationMap:function(pdf){var self=this,numPages=pdf.pdfInfo.numPages,pagePromises=[],allPagesPromise,destinationsPromise,outlinePromise,i;for(i=1;i<=numPages;i++){pagePromises.push(pdf.getPage(i))}allPagesPromise=Promise.all(pagePromises);allPagesPromise.then(function(pages){var ref;console.assert(pages.length===numPages);self._pageMap={};for(i=0;i<numPages;i++){ref=pages[i].pageInfo.ref.gen+"@"+pages[i].pageInfo.ref.num;self._pageMap[ref]=i+1}});outlinePromise=pdf.getOutline();destinationsPromise=pdf.getDestinations();Promise.all([allPagesPromise,destinationsPromise,outlinePromise]).then(function(p){var destinations=p[1],outline=p[2];function buildOL(items){var values=[],i,ref,destID,destination;for(i=0;i<items.length;i++){destID=items[i].dest;if(destID===undefined){console.warn("Could not find destination for outline item "+items[i].title);continue}else if(destinations[destID]!==undefined){destination=destinations[destID]}else if(destID instanceof Object){destination=destID}if(destination===undefined){console.warn("Could not find destination for outline item "+items[i].title);continue}ref=destination[0].gen+"@"+destination[0].num;values.push({title:items[i].title,page:self._pageMap[ref],children:buildOL(items[i].items)})}return values}outline=outline&&buildOL(outline)||[];self.set("outlineMap",outline)})}});PowerPack.PDF.RegionCommentBlock=RB.RegionCommentBlock.extend({defaults:_.defaults({page:null,scale:null,thumbnailData:null},RB.RegionCommentBlock.prototype.defaults),serializedFields:RB.RegionCommentBlock.prototype.serializedFields.concat(["page","thumbnailData"]),parse:function(fields){fields=RB.RegionCommentBlock.prototype.parse.call(this,fields);fields.page=parseInt(fields.page,10)||undefined;return fields}});PowerPack.PDF.Reviewable=RB.FileAttachmentReviewable.extend({defaults:_.defaults({commentBlockViews:[],currentPage:null,numPages:null,pages:null,pdf:null,scale:1},RB.FileAttachmentReviewable.prototype.defaults),commentBlockModel:PowerPack.PDF.RegionCommentBlock,initialize:function(attributes,options){var pdf=attributes.pdf;RB.FileAttachmentReviewable.prototype.initialize.call(this,attributes,options);pdf.on("change:pdfDocument",this._onDocumentChanged,this);this._onDocumentChanged(pdf,pdf.get("pdfDocument"))},_onDocumentChanged:function(pdf,pdfDocument){if(pdfDocument!==null){this.set({numPages:pdfDocument.pdfInfo.numPages,currentPage:1})}}});PowerPack.PDF.Sidebar=Backbone.Model.extend({defaults:function(){return{availableModes:[PowerPack.PDF.Sidebar.MODE_THUMBNAILS],mode:PowerPack.PDF.Sidebar.MODE_THUMBNAILS,reviewable:null,visible:false}},initialize:function(){var pdf=this.get("reviewable").get("pdf");this._modeIsDefault=true;this.on("change:mode",function(model,mode){this._modeIsDefault=false},this);this.listenTo(pdf,"change:outlineMap",this._onOutlineChanged);this._onOutlineChanged()},_onOutlineChanged:function(){var outline=this.get("reviewable").get("pdf").get("outlineMap");if(outline&&outline.length>0){this.set("availableModes",[PowerPack.PDF.Sidebar.MODE_OUTLINE,PowerPack.PDF.Sidebar.MODE_THUMBNAILS]);if(this._modeIsDefault){this.set("mode",PowerPack.PDF.Sidebar.MODE_OUTLINE)}}else{this.set("availableModes",[PowerPack.PDF.Sidebar.MODE_THUMBNAILS])}}},{MODE_OUTLINE:"outline",MODE_THUMBNAILS:"thumbnails",MODE_COMMENTS:"comments"});PowerPack.PDF.PageControlsView=Backbone.View.extend({className:"page-controls",events:{"change .pdf-page-curr":"_onChangePage","click .page-prev":"_onPrevPageClicked","click .page-next":"_onNextPageClicked"},template:_.template(['<div class="pdf-page-info">'," <%- pageText %>: ",' <input type="number" class="pdf-page-curr" min="1" /> '," <%- ofText %> ",' <span class="pdf-page-total"></span>',"</div>",'<div class="powerpack-pdf-icon powerpack-pdf-icon-page-prev ','            page-prev"','     title="<%- prevPageText %>"></div>','<div class="powerpack-pdf-icon powerpack-pdf-icon-page-next ','            page-next"','     title="<%- nextPageText %>"></div>'].join("")),initialize:function(){this._$currentPage=null;this._$totalPages=null},render:function(){this.$el.html(this.template({pageText:gettext("Page"),ofText:gettext("of"),prevPageText:gettext("Previous page"),nextPageText:gettext("Next page")}));this._$currentPage=this.$(".pdf-page-curr").bindProperty("value",this.model,"currentPage").bindProperty("max",this.model,"numPages");this._$totalPages=this.$(".pdf-page-total").bindProperty("text",this.model,"numPages");return this},_onChangePage:function(){var page=this._$currentPage.val();if(page>0&&page<=this.model.get("numPages")){this.model.set("currentPage",page)}else{this._$currentPage.val(this.model.get("currentPage"))}},_onPrevPageClicked:function(){var currentPage=this.model.get("currentPage");if(currentPage>1){this.model.set("currentPage",currentPage-1)}},_onNextPageClicked:function(){var currentPage=this.model.get("currentPage");if(currentPage<this.model.get("numPages")){this.model.set("currentPage",currentPage+1)}}});PowerPack.PDF.PageRendererView=Backbone.View.extend({initialize:function(){this._renderBusy=false;this._scheduledRenders=[]},scheduleRender:function(page,options){var renderInfo=_.defaults({page:page},options),i;if(renderInfo.highestPriority){if(page.inRenderQueue){for(i=0;i<this._scheduledRenders.length;i++){if(this._scheduledRenders[i].page===page){this._scheduledRenders.splice(i,1);break}}}this._scheduledRenders.unshift(renderInfo)}else{if(!page.inRenderQueue){this._scheduledRenders.push(renderInfo)}}page.inRenderQueue=true;this._processNextRender()},_processNextRender:_.throttle(function(){if(this._renderBusy){return}_.defer(_.bind(function(){var renderInfo;if(this._scheduledRenders.length===0){this.trigger("renderQueueEmpty")}else{renderInfo=this._scheduledRenders.shift();this._renderPage(renderInfo,{success:_.bind(function(){renderInfo.page.inRenderQueue=false;this._processNextRender()},this)})}},this))},10),_renderPage:function(renderInfo,options){var self=this,page=renderInfo.page;options=options||{};if(page.rendered){if(_.isFunction(options.success)){options.success()}return}this._renderBusy=true;this.model.get("pdf").getPage(page.pageNum).then(function(pdfPage){var pixelRatio=window.devicePixelRatio,viewport=pdfPage.getViewport((renderInfo.fitToWidth?page.$el.width()/pdfPage.getViewport(1).width:self.model.get("scale"))*pixelRatio),viewportSize={width:viewport.width,height:viewport.height},elementSize={width:Math.round(viewport.width/pixelRatio)+"px",height:Math.round(viewport.height/pixelRatio)+"px"};page.resize(elementSize,viewportSize);page.rendered=true;pdfPage.render({canvasContext:page.$canvas[0].getContext("2d"),viewport:viewport}).promise.then(function(){self._renderBusy=false;if(_.isFunction(options.success)){options.success()}}).catch(function(error){console.warning("Error while rendering pdf: "+error);self._renderBusy=false;page.rendered=false;if(_.isFunction(options.error)){options.error(error)}})})}});PowerPack.PDF.PagesView=Backbone.View.extend({className:"pdf-offset",events:{"mousedown .selection-container":"_onMouseDown",mouseup:"_onMouseUp",mousemove:"_onMouseMove",scroll:"_onScroll"},initialize:function(options){this._pageRenderer=options.pageRenderer;this._defaultPageNum=this.model.get("currentPage");this._docReady=false;this._scrolling=false;_.bindAll(this,"_resizeAllPages","_resizePagesBatch")},render:function(){var pdf=this.model.get("pdf");this.$el.empty();this._$outer=$('<div class="pdf-outer"/>').appendTo(this.$el);this._$inner=$('<div class="pdf-inner"/>').appendTo(this._$outer);this.listenTo(pdf,"change:pdfDocument",this._renderDocument);this._renderDocument(pdf,pdf.get("pdfDocument"));this.listenTo(this.model,"change:currentPage",this._onCurrentPageChanged);this._onCurrentPageChanged();this.listenTo(this.model,"change:scale",this._onZoomChanged);return this},isCommentDialogVisible:function(){return this.commentDlg&&!this.commentDlg.$el.is(":hidden")},_renderDocument:function(pdf,pdfDocument){var commentBlockViews=this.model.get("commentBlockViews"),pageView,numPages,pages,pixelRatio,scale,view,i;if(pdfDocument===null){return}numPages=pdfDocument.pdfInfo.numPages;pixelRatio=window.devicePixelRatio;scale=this.model.get("scale");pages=this.model.get("pages");for(i=0;i<numPages;i++){pageView=new PowerPack.PDF.PageView({pageNum:i+1,pagesView:this});pageView.render().$el.appendTo(this._$inner);pages.push(pageView)}this.model.get("pdf").getPage(1).then(_.bind(function(pdfPage){var viewport=pdfPage.getViewport(scale*pixelRatio),viewportSize={width:viewport.width,height:viewport.height},elementSize={width:Math.round(viewport.width/pixelRatio)+"px",height:Math.round(viewport.height/pixelRatio)+"px"},i;for(i=0;i<pages.length;i++){pages[i].resize(elementSize,viewportSize)}if(this._defaultPageNum){this.model.set("currentPage",this._defaultPageNum)}},this));for(i=0;i<commentBlockViews.length;i++){view=commentBlockViews[i];this.placeCommentBlockView(view.model.get("page"),view)}this._renderHighestPriorityPage();return this},placeCommentBlockView:function(pageNum,commentBlockView){var pages=this.model.get("pages");console.assert(pageNum<=pages.length);pages[pageNum-1].placeCommentBlockView(commentBlockView)},_renderHighestPriorityPage:function(){var i,visible,highestPriorityPageIx,pages;if(this._renderBusy){return}visible=this._getVisiblePages();i=_.find(visible,function(item){return!item.page.rendered});if(i!==undefined){highestPriorityPageIx=i.index}if(highestPriorityPageIx===undefined&&visible.length>0){pages=this.model.get("pages");i=visible[0].index-1;if(i>=0&&!pages[i].rendered){highestPriorityPageIx=i}i=visible[visible.length-1].index+1;if(highestPriorityPageIx===undefined&&i<pages.length&&!pages[i].rendered){highestPriorityPageIx=visible[visible.length-1].index+1}}if(highestPriorityPageIx!==undefined){this.listenToOnce(this._pageRenderer,"renderQueueEmpty",this._renderHighestPriorityPage);this._pageRenderer.scheduleRender(this.model.get("pages")[highestPriorityPageIx],{highestPriority:true})}},_getVisiblePages:function(){var scrollTop=this.el.scrollTop,scrollBottom=scrollTop+this.el.clientHeight,pages=this.model.get("pages"),visible=[],page,i;for(i=0;i<pages.length;i++){page=pages[i];boundsVisibility=page.getBoundsVisibility(scrollTop,scrollBottom);if(boundsVisibility.aboveBounds){continue}if(boundsVisibility.belowBounds){break}visible.push({page:page,index:i})}return visible},_getFirstVisiblePage:function(){var scrollTop=this.el.scrollTop,pages=this.model.get("pages"),pageEl,page,i;for(i=0;i<pages.length;i++){page=pages[i];pageEl=page.el;if(pageEl.offsetTop+pageEl.offsetHeight>=scrollTop){return page}}return null},_onMouseDown:function(ev){var $target=$(ev.target),$page=$target.parents(".pdf-page"),pageView;if(ev.which===1&&!this.isCommentDialogVisible()&&!$target.hasClass("selection-flag")){pageView=this.model.get("pages")[$page.data("pageIx")],this._activeSelection=pageView.beginSelection(ev);return false}},_onMouseUp:function(ev){var commentData;if(!this._activeSelection){return true}if(!this.isCommentDialogVisible()&&this._activeSelection.isValid()){ev.stopPropagation();commentData=this._activeSelection.finish(ev);this._activeSelection=null;if(commentData!==null){this.trigger("commentRegionCreated",commentData)}}},_onMouseMove:function(ev){if(!this._activeSelection){return true}if(!this.isCommentDialogVisible()&&this._activeSelection.isValid()){this._activeSelection.update(ev);return false}},_onScroll:function(ev){var scrollTop=this.el.scrollTop,scrollBottom=scrollTop+this.el.clientHeight,pages=this.model.get("pages"),biggestPageIx=-1,biggestPageSize=0,i;for(i=0;i<pages.length;i++){boundsVisibility=pages[i].getBoundsVisibility(scrollTop,scrollBottom);if(!boundsVisibility.aboveBounds&&!boundsVisibility.belowBounds&&boundsVisibility.overlapSize>biggestPageSize){biggestPageSize=boundsVisibility.overlapSize;biggestPageIx=i}}console.assert(biggestPageIx>=0);this._scrolling=true;this.model.set("currentPage",biggestPageIx+1);this._scrolling=false;this._renderHighestPriorityPage()},_onCurrentPageChanged:function(){var pages=this.model.get("pages"),pageNum=this.model.get("currentPage");if(pages.length===0||this._scrolling){return}console.assert(pageNum>=1);console.assert(pageNum<=pages.length);this.$el.scrollTop(pages[pageNum-1].$el.position().top)},_onZoomChanged:function(){var commentViews=this.model.get("commentBlockViews"),scale=this.model.get("scale"),pdf=this.model.get("pdf"),firstVisiblePage=this._getFirstVisiblePage(),firstVisiblePDFPage,offsetTopFromCanvas,topLeft,i;for(i=0;i<commentViews.length;i++){commentViews[i].model.set("scale",scale)}this.model.get("pdf").getPage(firstVisiblePage.pageNum).then(_.bind(function(pdfPage){var previousScale=this.model.previous("scale"),viewport=pdfPage.getViewport(previousScale),firstVisiblePagePos=firstVisiblePage.$canvas.position();offsetTopFromCanvas=this.el.scrollTop-firstVisiblePagePos.top;topLeft=viewport.convertToPdfPoint(this.el.scrollLeft-firstVisiblePagePos.left,offsetTopFromCanvas);topLeft=[Math.round(topLeft[0]),Math.round(topLeft[1])];firstVisiblePDFPage=pdfPage},this)).then(this._resizeAllPages).then(_.bind(function(){var firstVisiblePagePos=firstVisiblePage.$canvas.position();viewport=firstVisiblePDFPage.getViewport(scale),newTopLeft=viewport.convertToViewportPoint(topLeft[0],topLeft[1]);this.el.scrollLeft=firstVisiblePagePos.left+newTopLeft[0];this.el.scrollTop=firstVisiblePagePos.top+(offsetTopFromCanvas<0?offsetTopFromCanvas:newTopLeft[1]);this._renderHighestPriorityPage()},this))},_resizeAllPages:function(){var pages=this.model.get("pages"),pageSizes={},page,key,i;for(i=0;i<pages.length;i++){page=pages[i];key=page.$el.width()+"x"+page.$el.height();page.rendered=false;if(pageSizes[key]){pageSizes[key].push(page)}else{pageSizes[key]=[page]}}return Promise.all(_.map(pageSizes,this._resizePagesBatch))},_resizePagesBatch:function(pagesBatch){var pdf=this.model.get("pdf"),scale=this.model.get("scale"),pixelRatio=window.devicePixelRatio;return pdf.getPage(pagesBatch[0].pageNum).then(function(pdfPage){var viewport=pdfPage.getViewport(scale*pixelRatio),elementSize={width:Math.round(viewport.width/pixelRatio)+"px",height:Math.round(viewport.height/pixelRatio)+"px"},i;for(i=0;i<pagesBatch.length;i++){pagesBatch[i].resize(elementSize)}})}});PowerPack.PDF.RenderablePageView=Backbone.View.extend({initialize:function(options){this.pageNum=options.pageNum;this.$canvas=null;this.inRenderQueue=false;this.rendered=false},render:function(){this.$canvas=$("<canvas/>");return this},resize:function(elementSize,viewportSize){if(viewportSize){this.$canvas.attr(viewportSize)}this.$canvas.css(elementSize);this.$el.css(elementSize)}});PowerPack.PDF.PageView=PowerPack.PDF.RenderablePageView.extend({className:"pdf-page",events:{"mousedown .selection-container":"_onMouseDown",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},SELECTION_CLICK_EPSILON:5,initialize:function(options){_super(this).initialize.call(this,options);this.pagesView=options.pagesView;this._$selectionContainer=null;this._$selectionRect=null},render:function(){_super(this).render.call(this);this.$el.empty().data("pageIx",this.pageNum-1).attr("id","pdf-page-"+this.pageNum);this._$selectionRect=$("<div/>").addClass("selection-rect").proxyTouchEvents().hide();this._$selectionContainer=$("<div/>").addClass("selection-container").proxyTouchEvents().hide().append(this._$selectionRect).appendTo(this.$el);this.$canvas.addClass("pdf-canvas").appendTo(this.$el);return this},resize:function(elementSize,viewportSize){_super(this).resize.call(this,elementSize,viewportSize);this._$selectionContainer.css(elementSize)},getBoundsVisibility:function(boundsTop,boundsBottom){var pageTop=this.el.offsetTop,pageHeight=this.el.offsetHeight,pageBottom=pageTop+pageHeight,overlapTop=Math.max(pageTop,boundsTop),overlapBottom=Math.min(pageBottom,boundsBottom);return{aboveBounds:pageBottom<boundsTop,belowBounds:pageTop>boundsBottom,overlapSize:overlapBottom-overlapTop}},placeCommentBlockView:function(commentBlockView){this._$selectionContainer.append(commentBlockView.$el);if(commentBlockView.setSelectionRegionSizeFunc){commentBlockView.setSelectionRegionSizeFunc(_.bind(this._getSelectionRegionSize,this))}},beginSelection:function(ev){var offset=this.$el.offset(),x=ev.pageX-Math.floor(offset.left)-1,y=ev.pageY-Math.floor(offset.top)-1;this._$selectionRect.move(x,y).width(1).height(1).show();return{isValid:_.bind(function(){return this._$selectionRect.is(":visible")},this),update:_.bind(function(ev){this._updateSelection(ev,x,y)},this),finish:_.bind(this._finishSelection,this)}},_updateSelection:function(ev,beginX,beginY){var $el=this.$el,offset=$el.offset(),pageX=Math.floor(offset.left)-1,pageY=Math.floor(offset.top)-1,pageWidth=Math.floor($el.innerWidth()),pageHeight=Math.floor($el.innerHeight()),x=Math.min(Math.max(ev.pageX-pageX,0),pageWidth-2),y=Math.min(Math.max(ev.pageY-pageY,0),pageHeight-2);this._$selectionRect.css(beginX<=x?{left:beginX,width:x-beginX}:{left:x,width:beginX-x}).css(beginY<=y?{top:beginY,height:y-beginY}:{top:y,height:beginY-y})},_finishSelection:function(){var $selectionRect=this._$selectionRect,width=$selectionRect.width(),height=$selectionRect.height(),offset=$selectionRect.position(),pixelRatio=window.devicePixelRatio,scale,context,imageData,tempCanvas,sourceWidth,sourceHeight,x,y;$selectionRect.hide();if(width<=this.SELECTION_CLICK_EPSILON||height<=this.SELECTION_CLICK_EPSILON){return null}scale=this.pagesView.model.get("scale");context=this.$canvas[0].getContext("2d");x=Math.floor(offset.left*pixelRatio);y=Math.floor(offset.top*pixelRatio);sourceWidth=Math.floor(width*pixelRatio);sourceHeight=Math.floor(height*pixelRatio);imageData=context.getImageData(x,y,sourceWidth,sourceHeight);tempCanvas=$("<canvas>").attr({width:sourceWidth,height:sourceHeight})[0];tempCanvas.getContext("2d").putImageData(imageData,0,0);return{x:Math.floor(offset.left/scale),y:Math.floor(offset.top/scale),width:Math.round(width/scale),height:Math.round(height/scale),page:this.pageNum,thumbnailData:tempCanvas.toDataURL()}},_getSelectionRegionSize:function(){var $selectionContainer=this._$selectionContainer,offset=$selectionContainer.position();offset.left+=$selectionContainer.getExtents("m","l");return{left:offset.left,top:offset.top,width:$selectionContainer.width(),height:$selectionContainer.height()}},_onMouseEnter:function(){this._$selectionContainer.show()},_onMouseLeave:function(){if(this._$selectionRect.is(":hidden")&&!this.pagesView.isCommentDialogVisible()){this._$selectionContainer.hide()}}});PowerPack.PDF.SidebarModeView=Backbone.View.extend({setVisible:function(visible){this.$el.setVisible(visible)}});(function(){var OutlineEntryModel,OutlineEntryCollection,OutlineEntryView;OutlineEntryModel=Backbone.Model.extend({defaults:_.defaults({children:null,text:"",page:null}),parse:function(data){return{text:data.title,page:data.page,children:new OutlineEntryCollection(data.children,{parse:true})}}});OutlineEntryCollection=Backbone.Collection.extend({model:OutlineEntryModel,initialize:function(models){models=models.map(function(item){return new OutlineEntryModel(item,{parse:true})});Backbone.Collection.prototype.initialize.call(this,models)}});OutlineEntryView=Backbone.View.extend({tagName:"li",initialize:function(){this._childViews=this.model.get("children").map(function(model){return new OutlineEntryView({model:model})})},render:function(){this._$disclosure=$("<div/>").addClass("disclosure").appendTo(this.el).click(_.bind(this._toggleDisclosure,this));this._disclosed=false;$("<div/>").addClass("page-link").text(this.model.get("text")).data("page",this.model.get("page")).appendTo(this.el);if(this._childViews.length){this._$ul=$("<ul/>").appendTo(this.el);_.each(this._childViews,function(view){this._$ul.append(view.render().el)},this);this._$disclosure.css("visibility","visible");this._toggleDisclosure()}return this},_toggleDisclosure:function(){if(this._$disclosure!==undefined){if(this._disclosed){this._disclosed=false;this._$disclosure.text("▶");this._$ul.hide()}else{this._disclosed=true;this._$disclosure.text("▼");this._$ul.show()}}}});PowerPack.PDF.OutlineView=PowerPack.PDF.SidebarModeView.extend({tagName:"ul",events:{"click .page-link":"_onItemClicked"},initialize:function(){this._collection=null;this._childViews=[]},render:function(){var reviewable=this.model.get("reviewable"),pdf=reviewable.get("pdf");this.stopListening(pdf);this.listenTo(pdf,"change:outlineMap",this._buildOutlineViews);this._buildOutlineViews();return this},_buildOutlineViews:function(){var reviewable=this.model.get("reviewable"),pdf=reviewable.get("pdf");_.each(this._childViews,function(view){view.remove()});this._collection=new OutlineEntryCollection(pdf.get("outlineMap")||[],{parse:true});this._childViews=[];this._collection.each(function(model){var childView=new OutlineEntryView({model:model});this.$el.append(childView.render().el);this._childViews.push(childView)},this)},_onItemClicked:function(ev){var pageNum=$(ev.target).data("page"),reviewable=this.model.get("reviewable");if(pageNum!==null){reviewable.set("currentPage",pageNum)}}})})();PowerPack.PDF.RegionCommentBlockView=RB.RegionCommentBlockView.extend({initialize:function(){RB.RegionCommentBlockView.prototype.initialize.call(this);this.model.on("change:scale",this._updateDimensions,this)},_updateDimensions:function(){var model=this.model,scale=model.get("scale");this.$el.move(model.get("x")*scale,model.get("y")*scale,"absolute").width(model.get("width")*scale).height(model.get("height")*scale)}});PowerPack.PDF.ReviewableView=RB.FileAttachmentReviewableView.extend({className:"pdf-review-ui",commentBlockView:PowerPack.PDF.RegionCommentBlockView,template:_.template(['<div class="pdf-controls review-ui-header">',' <div class="controls-sidebar"></div>',' <div class="controls-center-outer">','  <div class="controls-center-inner">','   <div class="controls-page"></div>',"  </div>"," </div>",' <div class="controls-zoom"></div>',"</div>",'<div class="pdf-lower">',' <div class="pdf-nav">','  <div class="pdf-nav-outline" />','  <div class="pdf-nav-pages" />'," </div>",' <div class="pdf-offset"></div>',"</div>"].join("")),initialize:function(options){RB.AbstractReviewableView.prototype.initialize.call(this,options);this._activeSelection=null;this._bottomSpacing=null;this._sidebarView=null;this._pageControlsView=null;this._sidebarControlsView=null;this._zoomControlsView=null;this._pagesView=null;this._sidebar=new PowerPack.PDF.Sidebar({reviewable:this.model});this._pageRenderer=new PowerPack.PDF.PageRendererView({model:this.model});this._$lower=null;this._$window=$(window);this._$window.resize(_.bind(this._onWindowResize,this));if(location.hash&&location.hash.slice(0,6)==="#page-"){this.model.set("currentPage",parseInt(location.hash.slice(6),10))}this.on("commentBlockViewAdded",function(commentBlockView){var pages=this.model.get("pages");if(pages.length>0){this._pagesView.placeCommentBlockView(commentBlockView.model.get("page"),commentBlockView)}commentBlockView.model.set("scale",this.model.get("scale"));this.model.get("commentBlockViews").push(commentBlockView);commentBlockView.on("remove",function(){var viewsList=this.model.get("commentBlockViews");viewsList=_.without(viewsList,commentBlockView)},this)},this)},renderContent:function(){this.$el.html(this.template());this._$lower=this.$(".pdf-lower");this.model.set("pages",[]);this._sidebarView=new PowerPack.PDF.SidebarView({el:this.$(".pdf-nav"),model:this._sidebar,pageRenderer:this._pageRenderer});this._sidebarView.render();this.listenTo(this._sidebarView,"selectPage",this._jumpToPage);this._sidebarControlsView=new PowerPack.PDF.SidebarControlsView({el:this.$(".controls-sidebar"),model:this._sidebar});this._sidebarControlsView.render();this._pageControlsView=new PowerPack.PDF.PageControlsView({el:this.$(".controls-page"),model:this.model});this._pageControlsView.render();this._zoomControlsView=new PowerPack.PDF.ZoomControlsView({el:this.$(".controls-zoom"),model:this.model});this._zoomControlsView.render();this._pagesView=new PowerPack.PDF.PagesView({el:this.$(".pdf-offset"),model:this.model,pageRenderer:this._pageRenderer});this.listenTo(this._pagesView,"commentRegionCreated",this.createAndEditCommentBlock);this._pagesView.render();this.listenTo(this._sidebar,"change:visible",this._onSidebarToggled);_.defer(_.bind(this._onWindowResize,this));return this},_onWindowResize:function(){if(!this.el.parentElement){return}this._$lower.height(this._$window.height()-this._$lower.offset().top-this._getBottomSpacing()-1)},_getBottomSpacing:function(){if(this._bottomSpacing===null){this._bottomSpacing=0;_.each(this.$el.parents(),function(parentEl){this._bottomSpacing+=$(parentEl).getExtents("bmp","b")},this)}return this._bottomSpacing},_onSidebarToggled:function(){if(this._sidebar.get("visible")){this._sidebarView.$el.addClass("sidebar-open");this._pagesView.$el.addClass("sidebar-open")}else{this._sidebarView.$el.removeClass("sidebar-open");this._pagesView.$el.removeClass("sidebar-open")}this._onWindowResize()}});(function(){var ThumbnailView=PowerPack.PDF.RenderablePageView.extend({className:"item page-thumb",events:{"click canvas":"_onCanvasClicked"},setSelected:function(selected){if(selected){this.$el.addClass("selected")}else{this.$el.removeClass("selected")}},render:function(pageRenderer){_super(this).render.call(this);this.$el.data("page",this.pageNum).append(this.$canvas);pageRenderer.scheduleRender(this,{fitToWidth:true});return this},_onCanvasClicked:function(e){e.preventDefault();e.stopPropagation();this.$el.trigger("click")}});PowerPack.PDF.ThumbnailsView=PowerPack.PDF.SidebarModeView.extend({className:"page-thumbs",events:{"click .item":"_onItemClicked"},initialize:function(options){this.pageRenderer=options.pageRenderer;this.scrollContainer=options.scrollContainer;this._thumbnailViews=[];this._selectedThumbnailView=null},setVisible:function(visible){_super(this).setVisible.call(this,visible);if(visible&&this._selectedThumbnailView){this._scrollToSelectedThumbnail(false)}},render:function(){var reviewable=this.model.get("reviewable");this.stopListening(reviewable);this.listenTo(reviewable,"change:currentPage",this._onPageNumChanged);this._onPageNumChanged();this.listenTo(reviewable,"change:numPages",this._renderThumbnails);this._renderThumbnails();return this},_renderThumbnails:function(){var reviewable=this.model.get("reviewable"),thumbnailView,i;for(i=0;i<this._thumbnailViews.length;i++){this._thumbnailViews[i].remove()}this._thumbnailViews=[];this._selectedThumbnailView=null;for(i=1;i<=reviewable.get("numPages");i++){thumbnailView=new ThumbnailView({pageNum:i});thumbnailView.render(this.pageRenderer).$el.appendTo(this.$el);this._thumbnailViews.push(thumbnailView)}},_scrollToSelectedThumbnail:function(animate){var newScrollTop=null,$thumbnail=this._selectedThumbnailView.$el,thumbnailHeight=$thumbnail.outerHeight(true),thumbnailPos=$thumbnail.position(),scrollTop=this.scrollContainer.scrollTop,visibleHeight=this.scrollContainer.offsetHeight;if(thumbnailPos.top<0){newScrollTop=scrollTop+thumbnailPos.top}else if(thumbnailPos.top+thumbnailHeight>=visibleHeight){newScrollTop=scrollTop+thumbnailPos.top-visibleHeight+thumbnailHeight}if(newScrollTop!==null){if(animate!==false){$(this.scrollContainer).stop(true).animate({scrollTop:newScrollTop})}else{this.scrollContainer.scrollTop=newScrollTop}}},_onItemClicked:function(e){var pageNum=$(e.target).data("page"),reviewable=this.model.get("reviewable");if(pageNum){reviewable.set("currentPage",pageNum)}},_onPageNumChanged:function(){var reviewable=this.model.get("reviewable"),pageNum=reviewable.get("currentPage"),newScrollTop=null,thumbnailView,thumbnailHeight,thumbnailPos,scrollTop,scrollHeight;if(pageNum===null||this._thumbnailViews.length===0){return}thumbnailView=this._thumbnailViews[pageNum-1];if(this._selectedThumbnailView){this._selectedThumbnailView.setSelected(false)}thumbnailView.setSelected(true);this._selectedThumbnailView=thumbnailView;this._scrollToSelectedThumbnail()}})})();PowerPack.PDF.SidebarControlsView=Backbone.View.extend({className:"controls-sidebar",events:{"click .toggle-sidebar":"_onToggleSidebarClicked"},template:_.template(['<div class="powerpack-pdf-icon powerpack-pdf-icon-toggle-sidebar ','            toggle-sidebar"','     title="<%- toggleSidebarText %>" />','<div class="controls-sidebar-modes"></div>'].join("")),initialize:function(){this._$modes=null;this._$toggleSidebar=null},render:function(){this.stopListening(this.model);this.$el.html(this.template({toggleSidebarText:gettext("Toggle the page navigation sidebar")}));this._$toggleSidebar=this.$(".toggle-sidebar");this._$modes=this.$(".controls-sidebar-modes");this.listenTo(this.model,"change:availableModes",this._onAvailableModesChanged);this._onAvailableModesChanged();this.listenTo(this.model,"change:visible",this._onSidebarVisibleChanged);this.listenTo(this.model,"change:mode",this._onModeChanged);return this},_addSidebarMode:function(mode){$('<div class="powerpack-pdf-icon"/>').addClass("powerpack-pdf-icon-sidebar-mode-"+mode).addClass("sidebar-mode-"+mode).on("click",_.bind(function(){this.model.set("mode",mode)},this)).appendTo(this._$modes)},_onToggleSidebarClicked:function(){this.model.set("visible",!this.model.get("visible"))},_onAvailableModesChanged:function(){this._$modes.empty();_.each(this.model.get("availableModes"),this._addSidebarMode,this)},_onSidebarVisibleChanged:function(){if(this.model.get("visible")){this._$toggleSidebar.removeClass("powerpack-pdf-icon-toggle-sidebar").addClass("powerpack-pdf-icon-toggle-sidebar-active");this._$modes.addClass("sidebar-open")}else{this._$toggleSidebar.removeClass("powerpack-pdf-icon-toggle-sidebar-active").addClass("powerpack-pdf-icon-toggle-sidebar");this._$modes.removeClass("sidebar-open")}},_onModeChanged:function(){var oldMode=this.model.previous("mode"),newMode=this.model.get("mode");this.$(".sidebar-mode-"+oldMode).removeClass("powerpack-pdf-icon-sidebar-mode-"+oldMode+"-active").addClass("powerpack-pdf-icon-sidebar-mode-"+oldMode);this.$(".sidebar-mode-"+newMode).removeClass("powerpack-pdf-icon-sidebar-mode-"+newMode).addClass("powerpack-pdf-icon-sidebar-mode-"+newMode+"-active")}});PowerPack.PDF.SidebarView=Backbone.View.extend({initialize:function(options){this._pageRenderer=options.pageRenderer;this._currentView=null;this._outlineView=null;this._thumbnailsView=null},render:function(){var reviewable=this.model.get("reviewable"),pdf=reviewable.get("pdf"),outline=pdf.get("outlineMap");this._outlineSidebarView=this._createSidebarModeView(PowerPack.PDF.OutlineView,this.$(".pdf-nav-outline"));this._thumbnailsSidebarView=this._createSidebarModeView(PowerPack.PDF.ThumbnailsView,this.$(".pdf-nav-pages"),{pageRenderer:this._pageRenderer,scrollContainer:this.el});this.listenTo(this.model,"change:mode",this._onModeChanged);this._onModeChanged();return this},_createSidebarModeView:function(ViewType,$parent,viewOptions){var view=new ViewType(_.defaults({model:this.model},viewOptions));view.render().$el.hide().appendTo($parent);return view},_onModeChanged:function(){var mode=this.model.get("mode");if(this._currentSidebarView){this.stopListening(this._currentSidebarView,"sidebarItemSelected");
this._currentSidebarView.setVisible(false)}if(mode===PowerPack.PDF.Sidebar.MODE_OUTLINE){this._currentSidebarView=this._outlineSidebarView}else if(mode===PowerPack.PDF.Sidebar.MODE_THUMBNAILS){this._currentSidebarView=this._thumbnailsSidebarView}this.listenTo(this._currentSidebarView,"sidebarItemSelected",this._onSidebarItemSelected);this._currentSidebarView.setVisible(true)}});PowerPack.PDF.ZoomControlsView=Backbone.View.extend({className:"controls-zoom",events:{"click .zoom-out":"_onZoomOut","click .zoom-in":"_onZoomIn"},template:_.template(['<div class="fa fa-search-minus zoom-out"','     title="<%- zoomOutText %>"></div>','<div class="fa fa-search-plus zoom-in"','     title="<%- zoomInText %>"></div>'].join("")),render:function(){this.$el.html(this.template({zoomOutText:gettext("Zoom out"),zoomInText:gettext("Zoom in")}));return this},_onZoomOut:function(){this.model.set("scale",Math.floor(this.model.get("scale")*(3/4)*10)/10)},_onZoomIn:function(){this.model.set("scale",Math.ceil(this.model.get("scale")*(4/3)*10)/10)}})}).call(this);